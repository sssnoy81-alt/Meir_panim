<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×××©×§ ××ª× ×“×‘×™× - ×××™×¨ ×¤× ×™×</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B1538 0%, #E4032E 100%);
            min-height: 100vh;
            padding: 10px;
        }

        @media (min-width: 600px) {
            body {
                padding: 20px;
            }
        }

        .container { max-width: 1200px; margin: 0 auto; }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        @media (min-width: 600px) {
            .header {
                padding: 25px;
                margin-bottom: 20px;
            }
        }

        .header h1 { 
            color: #8B1538; 
            font-size: 22px; 
            margin-bottom: 10px; 
        }

        @media (min-width: 600px) {
            .header h1 {
                font-size: 28px;
            }
        }

        .header p {
            font-size: 14px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        @media (min-width: 600px) {
            .stats-container {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        @media (min-width: 600px) {
            .stat-card {
                padding: 20px;
            }
        }

        .stat-card h3 { 
            color: #666; 
            font-size: 12px; 
            margin-bottom: 8px; 
        }

        @media (min-width: 600px) {
            .stat-card h3 {
                font-size: 14px;
                margin-bottom: 10px;
            }
        }

        .stat-card .number { 
            font-size: 28px; 
            font-weight: bold; 
            color: #8B1538; 
        }

        @media (min-width: 600px) {
            .stat-card .number {
                font-size: 36px;
            }
        }

        .main-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        @media (min-width: 600px) {
            .main-panel {
                padding: 30px;
            }
        }

        .main-panel h2 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        @media (min-width: 600px) {
            .main-panel h2 {
                font-size: 24px;
            }
        }

        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        @media (min-width: 600px) {
            .search-section {
                padding: 30px;
                margin-bottom: 25px;
            }
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 12px;
        }

        @media (min-width: 600px) {
            .search-input {
                padding: 15px;
                font-size: 18px;
                margin-bottom: 15px;
            }
        }

        .search-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #8B1538 0%, #E4032E 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        @media (min-width: 600px) {
            .search-btn {
                padding: 15px;
                font-size: 18px;
            }
        }

        .search-btn:hover { transform: translateY(-2px); }
        .search-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .result-card {
            background: #f8f9fa;
            border: 2px solid #8B1538;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
        }

        .result-card h3 { color: #8B1538; margin-bottom: 15px; }

        .result-info {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (min-width: 600px) {
            .result-info {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 900px) {
            .result-info {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .info-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .info-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        @media (min-width: 600px) {
            .action-buttons {
                flex-direction: row;
                gap: 15px;
            }
        }

        .confirm-btn {
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .confirm-btn:hover { background: #218838; }

        .cancel-btn {
            width: 100%;
            padding: 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .export-btn {
            padding: 12px 25px;
            background: #E4032E;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        /* QR Scanner Styles */
        .scanner-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        #qr-reader {
            border: 2px solid #8B1538;
            border-radius: 10px;
            overflow: hidden;
            max-width: 100%;
        }

        .scanner-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .scanner-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .scanner-btn.stop {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .scanner-status {
            text-align: center;
            padding: 10px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .scanner-status.active {
            display: block;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: white;
            border: 2px solid #8B1538;
            color: #8B1538;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #8B1538 0%, #E4032E 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
                <div style="width: 50px; height: 50px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 10px rgba(0,0,0,0.2);">
                    <svg width="44" height="44" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="47" fill="#C1272D"/>
                        <circle cx="50" cy="50" r="47" fill="none" stroke="url(#volGrad)" stroke-width="3.5"/>
                        <defs>
                            <linearGradient id="volGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#FFA500;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#FF1493;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#9333EA;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path d="M 28 46 L 50 26 L 72 46 L 72 41 L 50 21 L 28 41 Z" fill="white"/>
                        <g transform="translate(35, 41)">
                            <circle cx="5" cy="5" r="3.5" fill="white"/>
                            <path d="M 2 12 Q 2 9, 5 9 Q 8 9, 8 12 L 8 16 L 2 16 Z" fill="white"/>
                        </g>
                        <g transform="translate(55, 41)">
                            <circle cx="5" cy="5" r="3.5" fill="white"/>
                            <path d="M 2 12 Q 2 9, 5 9 Q 8 9, 8 12 L 8 16 L 2 16 Z" fill="white"/>
                        </g>
                        <text x="50" y="70" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="white" text-anchor="middle">×××™×¨</text>
                        <text x="50" y="84" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="white" text-anchor="middle">×¤× ×™×</text>
                    </svg>
                </div>
                <h1 style="margin: 0;">ğŸ¤ ×××©×§ × ×™×”×•×œ ××ª× ×“×‘×™×</h1>
            </div>
            <p>×‘×™×ª ×ª××—×•×™ ×××™×¨ ×¤× ×™× - ×—×œ×•×§×ª ×—×‘×™×œ×•×ª ×¤×¡×— ×ª×©×¤"×”</p>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <h3>×¡×š ×”×›×œ × ×¨×©××•</h3>
                <div class="number" id="totalRegistrations">-</div>
            </div>
            <div class="stat-card">
                <h3>×§×™×‘×œ×• ×—×‘×™×œ×”</h3>
                <div class="number" id="receivedPackages">-</div>
            </div>
            <div class="stat-card">
                <h3>×××ª×™× ×™× ×œ××™×¡×•×£</h3>
                <div class="number" id="pendingPackages">-</div>
            </div>
            <div class="stat-card">
                <h3>×¡×š × ×¤×©×•×ª</h3>
                <div class="number" id="totalPeople">-</div>
            </div>
        </div>

        <div class="main-panel">
            <h2>ğŸ” ×–×™×”×•×™ ××©×¤×—×”</h2>
            
            <!-- Tab Buttons -->
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('scanner')">ğŸ“· ×¡×¨×™×§×ª QR</button>
                <button class="tab-btn" onclick="switchTab('manual')">âŒ¨ï¸ ×—×™×¤×•×© ×™×“× ×™</button>
            </div>

            <!-- QR Scanner Tab -->
            <div id="scannerTab" class="tab-content active">
                <div class="scanner-container">
                    <button class="scanner-btn" id="startScanBtn" onclick="startScanner()">
                        ğŸ“· ×”×ª×—×œ ×¡×¨×™×§×”
                    </button>
                    <div id="qr-reader" style="display: none;"></div>
                    <div class="scanner-status" id="scannerStatus"></div>
                </div>
            </div>

            <!-- Manual Search Tab -->
            <div id="manualTab" class="tab-content">
                <div class="search-section">
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="×”×§×œ×“ ××¡×¤×¨ ×¨×™×©×•×, ×ª×¢×•×“×ª ×–×”×•×ª ××• ×©× ××œ×...">
                    <button class="search-btn" id="searchBtn" onclick="searchFamily()">×—×¤×© ××©×¤×—×”</button>
                </div>
            </div>

            <div id="searchResult"></div>

            <button class="export-btn" onclick="exportToExcel()">ğŸ“¥ ×™×™×¦× ×“×•×— ×œ××§×¡×œ</button>
        </div>
    </div>

    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, doc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAmaAzUatTV97LwL4VoVEUrJoVpnF612ig",
            authDomain: "meir-panim-f27c4.firebaseapp.com",
            projectId: "meir-panim-f27c4",
            storageBucket: "meir-panim-f27c4.firebasestorage.app",
            messagingSenderId: "252083260218",
            appId: "1:252083260218:web:ea5e1e072aed819b8d1e03"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allRegistrations = [];
        let html5QrCode = null;
        let isScanning = false;

        // Tab Switching
        window.switchTab = function(tab) {
            // Stop scanner if switching away
            if (tab !== 'scanner' && isScanning) {
                stopScanner();
            }

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.getElementById('scannerTab').classList.remove('active');
            document.getElementById('manualTab').classList.remove('active');

            if (tab === 'scanner') {
                document.getElementById('scannerTab').classList.add('active');
            } else {
                document.getElementById('manualTab').classList.add('active');
            }

            // Clear results
            document.getElementById('searchResult').innerHTML = '';
        };

        // QR Scanner Functions
        window.startScanner = async function() {
            const qrReaderDiv = document.getElementById('qr-reader');
            const statusDiv = document.getElementById('scannerStatus');
            const startBtn = document.getElementById('startScanBtn');

            try {
                qrReaderDiv.style.display = 'block';
                startBtn.textContent = 'â¹ï¸ ×¢×¦×•×¨ ×¡×¨×™×§×”';
                startBtn.classList.add('stop');
                startBtn.onclick = stopScanner;

                statusDiv.textContent = 'ğŸ“· ×”×¡×•×¨×§ ×¤×¢×™×œ - ×”×¦××“ QR Code ×œ××¦×œ××”';
                statusDiv.className = 'scanner-status active';
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';

                html5QrCode = new Html5Qrcode("qr-reader");

                const config = { 
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                };

                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanError
                );

                isScanning = true;
            } catch (err) {
                console.error('Error starting scanner:', err);
                statusDiv.textContent = 'âŒ ×©×’×™××” ×‘×”×¤×¢×œ×ª ×”××¦×œ××”: ' + err.message;
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.classList.add('active');
                
                qrReaderDiv.style.display = 'none';
                startBtn.textContent = 'ğŸ“· ×”×ª×—×œ ×¡×¨×™×§×”';
                startBtn.classList.remove('stop');
                startBtn.onclick = startScanner;
            }
        };

        window.stopScanner = async function() {
            if (html5QrCode && isScanning) {
                try {
                    await html5QrCode.stop();
                    html5QrCode.clear();
                } catch (err) {
                    console.error('Error stopping scanner:', err);
                }

                document.getElementById('qr-reader').style.display = 'none';
                
                const statusDiv = document.getElementById('scannerStatus');
                statusDiv.textContent = '×”×¡×•×¨×§ ×”×•×¤×¡×§';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';

                const startBtn = document.getElementById('startScanBtn');
                startBtn.textContent = 'ğŸ“· ×”×ª×—×œ ×¡×¨×™×§×”';
                startBtn.classList.remove('stop');
                startBtn.onclick = startScanner;

                isScanning = false;
            }
        };

        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Code scanned:', decodedText);
            
            // Stop scanner
            stopScanner();

            // Parse QR data
            try {
                const qrData = JSON.parse(decodedText);
                const registrationNumber = qrData.id || qrData.registrationNumber;

                if (registrationNumber) {
                    // Search by registration number
                    searchByRegistrationNumber(registrationNumber);
                } else {
                    showError('QR Code ×œ× ×ª×§×™×Ÿ - ××™×Ÿ ××¡×¤×¨ ×¨×™×©×•×');
                }
            } catch (e) {
                // If not JSON, try as plain text (might be just registration number)
                searchByRegistrationNumber(decodedText);
            }
        }

        function onScanError(errorMessage) {
            // Ignore scan errors (they happen when no QR code is in view)
            // console.log('Scan error:', errorMessage);
        }

        async function searchByRegistrationNumber(regNumber) {
            const resultDiv = document.getElementById('searchResult');
            
            resultDiv.innerHTML = '<div class="alert alert-info">××—×¤×©...</div>';

            const result = allRegistrations.find(r => r.registrationNumber === regNumber);

            if (result) {
                if (result.packageReceived) {
                    const receivedDate = result.receivedDate?.toDate ? 
                        result.receivedDate.toDate().toLocaleString('he-IL') : 
                        '×œ× ×™×“×•×¢';
                    
                    resultDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <h3>âš ï¸ ××©×¤×—×” ×–×• ×›×‘×¨ ×§×™×‘×œ×” ×—×‘×™×œ×”</h3>
                            <p><strong>×ª××¨×™×š ×§×‘×œ×”:</strong> ${receivedDate}</p>
                            <p><strong>×©×:</strong> ${result.fullName}</p>
                            <p><strong>××¡×¤×¨ ×¨×™×©×•×:</strong> ${result.registrationNumber}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result-card">
                            <h3>âœ… ××©×¤×—×” × ××¦××” ×‘××¢×¨×›×ª</h3>
                            <div class="result-info">
                                <div class="info-item">
                                    <label>×©× ××œ×</label>
                                    <div class="value">${result.fullName}</div>
                                </div>
                                <div class="info-item">
                                    <label>××¡×¤×¨ ×¨×™×©×•×</label>
                                    <div class="value">${result.registrationNumber}</div>
                                </div>
                                <div class="info-item">
                                    <label>×ª×¢×•×“×ª ×–×”×•×ª</label>
                                    <div class="value">${result.idNumber}</div>
                                </div>
                                <div class="info-item">
                                    <label>××¡×¤×¨ × ×¤×©×•×ª</label>
                                    <div class="value">${result.familySize}</div>
                                </div>
                                <div class="info-item">
                                    <label>×˜×œ×¤×•×Ÿ</label>
                                    <div class="value">${result.phone || '×œ× ×¦×•×™×Ÿ'}</div>
                                </div>
                                <div class="info-item">
                                    <label>×¢×™×¨</label>
                                    <div class="value">${result.city}</div>
                                </div>
                            </div>
                            ${result.notes ? `<p style="margin-top: 15px;"><strong>×”×¢×¨×•×ª:</strong> ${result.notes}</p>` : ''}
                            <div class="action-buttons">
                                <button class="confirm-btn" onclick="confirmDelivery('${result.id}', '${result.fullName}', '${result.familySize}')">
                                    âœ… ××©×¨ ××¡×™×¨×ª ×—×‘×™×œ×”
                                </button>
                                <button class="cancel-btn" onclick="clearResult()">
                                    âŒ ×‘×™×˜×•×œ
                                </button>
                            </div>
                        </div>
                    `;
                }
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h3>âŒ ×œ× × ××¦××” ××©×¤×—×” ×‘××¢×¨×›×ª</h3>
                        <p>××¡×¤×¨ ×¨×™×©×•×: ${regNumber}</p>
                    </div>
                `;
            }
        }

        function showError(message) {
            document.getElementById('searchResult').innerHTML = `
                <div class="alert alert-error">
                    <h3>âŒ ×©×’×™××”</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // Load statistics
        async function updateStats() {
            try {
                const querySnapshot = await getDocs(collection(db, 'registrations'));
                allRegistrations = [];
                
                querySnapshot.forEach((doc) => {
                    allRegistrations.push({ id: doc.id, ...doc.data() });
                });

                const total = allRegistrations.length;
                const received = allRegistrations.filter(r => r.packageReceived).length;
                const totalPeople = allRegistrations.reduce((sum, r) => {
                    const size = parseInt(r.familySize) || 0;
                    return sum + size;
                }, 0);

                document.getElementById('totalRegistrations').textContent = total;
                document.getElementById('receivedPackages').textContent = received;
                document.getElementById('pendingPackages').textContent = total - received;
                document.getElementById('totalPeople').textContent = totalPeople;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Search family
        window.searchFamily = async function() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const searchBtn = document.getElementById('searchBtn');
            const resultDiv = document.getElementById('searchResult');

            if (!searchTerm) {
                resultDiv.innerHTML = '<div class="alert alert-warning">×× × ×”×–×Ÿ ××¡×¤×¨ ×¨×™×©×•×, ×ª.×– ××• ×©×</div>';
                return;
            }

            searchBtn.disabled = true;
            searchBtn.textContent = '××—×¤×©...';

            try {
                const result = allRegistrations.find(r =>
                    r.registrationNumber === searchTerm ||
                    r.idNumber === searchTerm ||
                    r.fullName.includes(searchTerm)
                );

                if (result) {
                    if (result.packageReceived) {
                        const receivedDate = result.receivedDate?.toDate ? 
                            result.receivedDate.toDate().toLocaleString('he-IL') : 
                            '×œ× ×™×“×•×¢';
                        
                        resultDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <h3>âš ï¸ ××©×¤×—×” ×–×• ×›×‘×¨ ×§×™×‘×œ×” ×—×‘×™×œ×”</h3>
                                <p>×ª××¨×™×š ×§×‘×œ×”: ${receivedDate}</p>
                                <p>×©×: ${result.fullName}</p>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="result-card">
                                <h3>âœ… ××©×¤×—×” × ××¦××” ×‘××¢×¨×›×ª</h3>
                                <div class="result-info">
                                    <div class="info-item">
                                        <label>×©× ××œ×</label>
                                        <div class="value">${result.fullName}</div>
                                    </div>
                                    <div class="info-item">
                                        <label>××¡×¤×¨ ×¨×™×©×•×</label>
                                        <div class="value">${result.registrationNumber}</div>
                                    </div>
                                    <div class="info-item">
                                        <label>×ª×¢×•×“×ª ×–×”×•×ª</label>
                                        <div class="value">${result.idNumber}</div>
                                    </div>
                                    <div class="info-item">
                                        <label>××¡×¤×¨ × ×¤×©×•×ª</label>
                                        <div class="value">${result.familySize}</div>
                                    </div>
                                    <div class="info-item">
                                        <label>×˜×œ×¤×•×Ÿ</label>
                                        <div class="value">${result.phone || '×œ× ×¦×•×™×Ÿ'}</div>
                                    </div>
                                    <div class="info-item">
                                        <label>×¢×™×¨</label>
                                        <div class="value">${result.city}</div>
                                    </div>
                                </div>
                                ${result.notes ? `<p><strong>×”×¢×¨×•×ª:</strong> ${result.notes}</p>` : ''}
                                <div class="action-buttons">
                                    <button class="confirm-btn" onclick="confirmDelivery('${result.id}', '${result.fullName}', '${result.familySize}')">
                                        âœ… ××©×¨ ××¡×™×¨×ª ×—×‘×™×œ×”
                                    </button>
                                    <button class="cancel-btn" onclick="clearResult()">
                                        âŒ ×‘×™×˜×•×œ
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            <h3>âŒ ×œ× × ××¦××” ××©×¤×—×” ×‘××¢×¨×›×ª</h3>
                            <p>×× × ×‘×“×•×§ ××ª ×”×¤×¨×˜×™× ×•× ×¡×” ×©×•×‘</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error searching:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <h3>×©×’×™××” ×‘×—×™×¤×•×©</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }

            searchBtn.disabled = false;
            searchBtn.textContent = '×—×¤×© ××©×¤×—×”';
        };

        // Confirm delivery
        window.confirmDelivery = async function(docId, fullName, familySize) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××©×¨ ××¡×™×¨×ª ×—×‘×™×œ×” ×œ××©×¤×—×” ×–×•?')) {
                return;
            }

            try {
                const docRef = doc(db, 'registrations', docId);
                await updateDoc(docRef, {
                    packageReceived: true,
                    receivedDate: serverTimestamp()
                });

                document.getElementById('searchResult').innerHTML = `
                    <div class="alert alert-success">
                        <h3>âœ… ×”×—×‘×™×œ×” × ××¡×¨×” ×‘×”×¦×œ×—×”!</h3>
                        <p>××©×¤×—×ª ${fullName} - ${familySize} × ×¤×©×•×ª</p>
                        <p>×©×¢×”: ${new Date().toLocaleTimeString('he-IL')}</p>
                    </div>
                `;

                updateStats();

                setTimeout(() => {
                    clearResult();
                    document.getElementById('searchInput').value = '';
                }, 3000);
            } catch (error) {
                alert('×©×’×™××” ×‘××™×©×•×¨ ××¡×™×¨×”: ' + error.message);
            }
        };

        window.clearResult = function() {
            document.getElementById('searchResult').innerHTML = '';
        };

        // Export to Excel
        window.exportToExcel = function() {
            let csv = '××¡×¤×¨ ×¨×™×©×•×,×©× ××œ×,×ª.×–,×˜×œ×¤×•×Ÿ,×¢×™×¨,× ×¤×©×•×ª,×”×¢×¨×•×ª,×¡×˜×˜×•×¡,×ª××¨×™×š ×¨×™×©×•×,×ª××¨×™×š ×§×‘×œ×”\n';

            allRegistrations.forEach(r => {
                const regDate = r.registrationDate?.toDate ? 
                    r.registrationDate.toDate().toLocaleDateString('he-IL') : '';
                const recDate = r.receivedDate?.toDate ? 
                    r.receivedDate.toDate().toLocaleDateString('he-IL') : '';

                csv += `${r.registrationNumber},${r.fullName},${r.idNumber},${r.phone || ''},${r.city},${r.familySize},${r.notes || ''},${r.packageReceived ? '×”×ª×§×‘×œ×”' : '×××ª×™×Ÿ'},${regDate},${recDate}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `×××™×¨_×¤× ×™×_${new Date().toLocaleDateString('he-IL')}.csv`;
            link.click();
        };

        // Enter key to search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchFamily();
            }
        });

        // Initial load
        updateStats();
        setInterval(updateStats, 30000); // Update every 30 seconds
    </script>
</body>
</html>
