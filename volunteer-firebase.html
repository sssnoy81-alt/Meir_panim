<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××–×•×¨ ×× ×”×œ×™ ×¡× ×™×£ - ×××™×¨ ×¤× ×™×</title>

  <meta name="description" content="××¢×¨×›×ª × ×™×”×•×œ ×—×œ×•×§×ª ×—×‘×™×œ×•×ª ××–×•×Ÿ - ×‘×™×ª ×ª××—×•×™ ×××™×¨ ×¤× ×™×">
  <meta name="theme-color" content="#8B1538">
  <link rel="manifest" href="manifest.json">

  <script src="users-config.js"></script>

  <script>
    // Check authentication
    const authData = sessionStorage.getItem('meirPanimAuth');
    const authTime = sessionStorage.getItem('meirPanimAuthTime');

    let userSession = null;

    if (!authData || !authTime) {
      window.location.href = 'login.html?redirect=volunteer-firebase.html';
    } else {
      const now = new Date().getTime();
      const elapsed = now - parseInt(authTime);
      const hours24 = 24 * 60 * 60 * 1000;

      if (elapsed >= hours24) {
        sessionStorage.removeItem('meirPanimAuth');
        sessionStorage.removeItem('meirPanimAuthTime');
        window.location.href = 'login.html?redirect=volunteer-firebase.html';
      } else {
        userSession = JSON.parse(authData);
        console.log('Logged in as:', userSession.hebrewName, 'Branch:', userSession.branch);
      }
    }
  </script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{background:linear-gradient(135deg,#8B1538 0%,#E4032E 100%);color:#fff;padding:20px 30px;border-radius:15px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .header h1{font-size:28px;margin-bottom:10px}
    .user-info{background:rgba(255,255,255,.2);padding:10px 20px;border-radius:8px;font-size:16px}
    .logout-btn{background:rgba(255,255,255,.3);border:2px solid #fff;color:#fff;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;transition:.3s}
    .logout-btn:hover{background:#fff;color:#8B1538}
    .tabs{display:flex;gap:10px;margin-bottom:20px}
    .tab{flex:1;padding:15px;background:#fff;border:none;border-radius:10px;cursor:pointer;font-size:18px;font-weight:600;color:#666;transition:.3s;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .tab.active{background:linear-gradient(135deg,#8B1538 0%,#E4032E 100%);color:#fff;transform:translateY(-2px);box-shadow:0 4px 15px rgba(139,21,56,.3)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .card{background:#fff;border-radius:15px;padding:30px;box-shadow:0 5px 20px rgba(0,0,0,.1);margin-bottom:20px}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#333}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;transition:border-color .3s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#8B1538}
    .required{color:#E4032E}
    .btn-primary{width:100%;padding:15px;background:linear-gradient(135deg,#8B1538 0%,#E4032E 100%);color:#fff;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;transition:transform .2s}
    .btn-primary:hover{transform:translateY(-2px)}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed}
    .registrations-list{max-height:600px;overflow-y:auto}
    .registration-item{background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:15px;border-left:5px solid #8B1538}
    .registration-item.delivered{border-left-color:#28a745;background:#e8f5e9}
    .registration-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .registration-number{font-size:18px;font-weight:700;color:#8B1538}
    .badge{padding:5px 15px;border-radius:20px;font-size:14px;font-weight:600}
    .badge-pending{background:#fff3cd;color:#856404}
    .badge-delivered{background:#d4edda;color:#155724}
    .registration-details{margin:15px 0;line-height:1.8}
    .registration-details div{margin-bottom:5px}
    .btn-mark-delivered{width:100%;padding:12px;background:#28a745;color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;margin-top:15px;transition:background .3s}
    .btn-mark-delivered:hover{background:#218838}
    .search-box{width:100%;padding:15px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;margin-bottom:20px}
    .search-box:focus{outline:none;border-color:#8B1538}
    .mini-dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
    .mini-card{background:#fff;padding:20px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,.1);text-align:center}
    .mini-card-value{font-size:36px;font-weight:700;color:#8B1538;margin:10px 0}
    .mini-card-label{font-size:16px;color:#666}
    .success-message{background:#d4edda;color:#155724;padding:15px;border-radius:8px;margin-bottom:20px;display:none;text-align:center;font-weight:600}
    .empty-state{text-align:center;padding:60px 20px;color:#999}
    .empty-state-icon{font-size:64px;margin-bottom:20px}
    .btn-export{background:#28a745;color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;margin-bottom:20px;transition:background .3s}
    .btn-export:hover{background:#218838}
  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <div>
      <h1>ğŸ  ××–×•×¨ ×× ×”×œ×™ ×¡× ×™×£</h1>
      <div class="user-info">
        ğŸ‘¤ <span id="userName"></span> | ğŸ“ <span id="userBranch"></span>
      </div>
    </div>
    <button class="logout-btn" onclick="logout()">ğŸšª ×”×ª× ×ª×§</button>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('register')">â• ×¨×™×©×•× ×—×“×©</button>
    <button class="tab" onclick="switchTab('view')">ğŸ“‹ ×¦×¤×™×™×” ×‘×¨×©×•××™×</button>
  </div>

  <div id="registerTab" class="tab-content active">
    <div class="card">
      <h2 style="margin-bottom: 20px; color: #8B1538;">×¨×™×©×•× ××©×¤×—×” ×—×“×©×”</h2>
      <div id="successMessage" class="success-message"></div>

      <form id="registrationForm">
        <div class="form-group">
          <label>×©× ××œ× <span class="required">*</span></label>
          <input type="text" id="fullName" required placeholder="×”×›× ×¡ ×©× ××œ×">
        </div>

        <div class="form-group">
          <label>××¡×¤×¨ ×ª×¢×•×“×ª ×–×”×•×ª <span class="required">*</span></label>
          <input type="text" id="idNumber" required placeholder="9 ×¡×¤×¨×•×ª" maxlength="9">
        </div>

        <div class="form-group">
          <label>××¡×¤×¨ ×˜×œ×¤×•×Ÿ (×œ×©×œ×™×—×ª SMS)</label>
          <input type="tel" id="phone" placeholder="050-1234567">
        </div>

        <div class="form-group">
          <label>×¢×™×¨ <span class="required">*</span></label>
          <select id="city" required>
            <option value="">×‘×—×¨ ×¢×™×¨</option>
            <option value="×™×¨×•×©×œ×™×">×™×¨×•×©×œ×™×</option>
            <option value="×¦×¤×ª">×¦×¤×ª</option>
            <option value="×“×™××•× ×”">×“×™××•× ×”</option>
            <option value="××•×¨ ×¢×§×™×‘×">××•×¨ ×¢×§×™×‘×</option>
            <option value="×˜×‘×¨×™×”">×˜×‘×¨×™×”</option>
          </select>
        </div>

        <div class="form-group">
          <label>×¡×•×’ ×—×‘×™×œ×” <span class="required">*</span></label>
          <select id="packageType" required>
            <option value="">×‘×—×¨ ×¡×•×’ ×—×‘×™×œ×”</option>
            <option value="×—×‘×™×œ×ª ××–×•×Ÿ">×—×‘×™×œ×ª ××–×•×Ÿ</option>
            <option value="×ª×œ×•×©/×©×•×‘×¨">×ª×œ×•×©/×©×•×‘×¨</option>
            <option value="×—×‘×™×œ×” + ×©×•×‘×¨">×—×‘×™×œ×” + ×©×•×‘×¨</option>
          </select>
        </div>

        <div class="form-group">
          <label>×”×¢×¨×•×ª</label>
          <textarea id="notes" rows="3" placeholder="×¦×¨×›×™× ××™×•×—×“×™×, ××œ×¨×’×™×•×ª ×•×›×•'"></textarea>
        </div>

        <button type="submit" class="btn-primary" id="submitBtn">×©××•×¨ ×¨×™×©×•×</button>
      </form>
    </div>
  </div>

  <div id="viewTab" class="tab-content">
    <div class="card">
      <h2 style="margin-bottom: 20px; color: #8B1538;">×¨×©×•××™× ×‘×¡× ×™×£</h2>

      <div class="mini-dashboard">
        <div class="mini-card">
          <div class="mini-card-label">×¡×”"×› ×¨×©×•××™×</div>
          <div class="mini-card-value" id="miniTotalCount">0</div>
        </div>
        <div class="mini-card">
          <div class="mini-card-label">×××ª×™× ×™× ×œ××¡×™×¨×”</div>
          <div class="mini-card-value" id="miniPendingCount" style="color:#ffc107;">0</div>
        </div>
        <div class="mini-card">
          <div class="mini-card-label">× ××¡×¨×•</div>
          <div class="mini-card-value" id="miniDeliveredCount" style="color:#28a745;">0</div>
        </div>
      </div>

      <button class="btn-export" onclick="exportToExcel()">ğŸ“Š ×™×™×¦×•× ×œ××§×¡×œ</button>

      <input type="text" id="searchBox" class="search-box" placeholder="ğŸ” ×—×™×¤×•×© ×œ×¤×™ ××¡×¤×¨ ×”×–×× ×”..." oninput="filterRegistrations()">

      <div class="registrations-list" id="registrationsList">
        <div class="empty-state">
          <div class="empty-state-icon">â³</div>
          <p>×˜×•×¢×Ÿ...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAmnAzUatfV97LwL4VoVEUrJoVnnF6I2J4",
    authDomain: "meir-panim-f27c4.firebaseapp.com",
    projectId: "meir-panim-f27c4",
    storageBucket: "meir-panim-f27c4.firebasestorage.app",
    messagingSenderId: "252083260218",
    appId: "1:252083260218:web:ea5e1ef072ae048191dd1e03",
    measurementId: "G-VXGZ0RHHD5"
  };

  const SMS_WORKER_URL = "https://meir-panim-sms.sssnoy81.workers.dev/";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  document.getElementById('userName').textContent = userSession.hebrewName;
  document.getElementById('userBranch').textContent = userSession.branch || '×›×œ ×”×¡× ×™×¤×™×';

  window.logout = function() {
    sessionStorage.removeItem('meirPanimAuth');
    sessionStorage.removeItem('meirPanimAuthTime');
    window.location.href = 'login.html';
  };

  window.switchTab = function(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

    if (tabName === 'register') {
      document.querySelector('.tab:nth-child(1)').classList.add('active');
      document.getElementById('registerTab').classList.add('active');
    } else {
      document.querySelector('.tab:nth-child(2)').classList.add('active');
      document.getElementById('viewTab').classList.add('active');
      loadRegistrations();
    }
  };

  function formatILPhoneToE164(raw) {
    if (!raw) return "";
    let p = raw.replace(/\D/g, "");
    if (!p) return "";
    if (p.startsWith("0")) return "+972" + p.substring(1);
    if (p.startsWith("972")) return "+" + p;
    if (p.startsWith("+")) return p;
    return "+972" + p;
  }

  async function sendSms(toE164, body) {
    if (!toE164) return;
    await fetch(SMS_WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ to: toE164, body })
    });
  }

  const registrationForm = document.getElementById('registrationForm');
  const submitBtn = document.getElementById('submitBtn');

  registrationForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    submitBtn.disabled = true;
    submitBtn.textContent = '×©×•××¨...';

    const registrationNumber = 'MP' + Date.now().toString().slice(-8);

    const formData = {
      fullName: document.getElementById('fullName').value,
      idNumber: document.getElementById('idNumber').value,
      phone: document.getElementById('phone').value || '',
      city: document.getElementById('city').value,
      packageType: document.getElementById('packageType').value,
      notes: document.getElementById('notes').value || '',
      registrationDate: serverTimestamp(),
      registrationNumber,
      packageReceived: false,
      receivedDate: null,
      registeredBy: userSession.username,
      registeredByName: userSession.hebrewName
    };

    try {
      await addDoc(collection(db, 'registrations'), formData);

      const successMsg = document.getElementById('successMessage');
      successMsg.textContent = `âœ… × ×¨×©× ×‘×”×¦×œ×—×”! ××¡×¤×¨ ×”×–×× ×”: ${registrationNumber}`;
      successMsg.style.display = 'block';

      // âœ… SMS (×× ×”×•×–×Ÿ ×˜×œ×¤×•×Ÿ)
      if (formData.phone) {
        const to = formatILPhoneToE164(formData.phone);
        const qrLink = `https://sssnoy81-alt.github.io/Meir_panim/qr.html?code=${encodeURIComponent(registrationNumber)}`;

        const smsBody =
`×××™×¨ ×¤× ×™× âœ…
××¡×¤×¨ ×”×”×–×× ×” ×©×œ×š: ${registrationNumber}

×œ×¡×¨×™×§×ª QR:
${qrLink}

×©××•×¨ ×”×•×“×¢×” ×–×• ×•×”×¦×’ ×‘×¢××“×ª ×”×—×œ×•×§×”.`;

        await sendSms(to, smsBody);
      }

      e.target.reset();
      setTimeout(() => { successMsg.style.display = 'none'; }, 5000);

    } catch (error) {
      console.error('Error:', error);
      alert('×©×’×™××” ×‘×©××™×¨×”/×©×œ×™×—×”. × ×¡×” ×©×•×‘.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = '×©××•×¨ ×¨×™×©×•×';
    }
  });

  let allRegistrations = [];

  async function loadRegistrations() {
    const listDiv = document.getElementById('registrationsList');
    listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â³</div><p>×˜×•×¢×Ÿ...</p></div>';

    try {
      let querySnapshot;

      if (userSession.permissions.viewAll) {
        querySnapshot = await getDocs(collection(db, 'registrations'));
      } else {
        const q = query(collection(db, 'registrations'), where('city', '==', userSession.branch));
        querySnapshot = await getDocs(q);
      }

      allRegistrations = [];
      querySnapshot.forEach((d) => allRegistrations.push({ id: d.id, ...d.data() }));

      updateMiniDashboard();

      if (allRegistrations.length === 0) {
        listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>××™×Ÿ ×¨×©×•××™× ×¢×“×™×™×Ÿ</p></div>';
        return;
      }

      displayRegistrations(allRegistrations);

    } catch (error) {
      console.error('Error loading registrations:', error);
      listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</p></div>';
    }
  }

  function updateMiniDashboard() {
    const total = allRegistrations.length;
    const delivered = allRegistrations.filter(r => r.packageReceived).length;
    const pending = total - delivered;

    document.getElementById('miniTotalCount').textContent = total;
    document.getElementById('miniPendingCount').textContent = pending;
    document.getElementById('miniDeliveredCount').textContent = delivered;
  }

  function displayRegistrations(registrations) {
    const listDiv = document.getElementById('registrationsList');

    registrations.sort((a, b) => {
      if (!a.registrationDate || !b.registrationDate) return 0;
      return b.registrationDate.seconds - a.registrationDate.seconds;
    });

    let html = '';
    registrations.forEach(reg => {
      const status = reg.packageReceived ? 'delivered' : 'pending';
      const statusBadge = reg.packageReceived
        ? '<span class="badge badge-delivered">âœ… × ××¡×¨</span>'
        : '<span class="badge badge-pending">â³ ×××ª×™×Ÿ</span>';

      html += `
        <div class="registration-item ${status}" data-registration-number="${reg.registrationNumber || ''}">
          <div class="registration-header">
            <div class="registration-number">${reg.registrationNumber || '×œ× ×–××™×Ÿ'}</div>
            ${statusBadge}
          </div>
          <div class="registration-details">
            <div><strong>ğŸ‘¤ ×©×:</strong> ${reg.fullName}</div>
            <div><strong>ğŸ†” ×ª.×–:</strong> ${reg.idNumber}</div>
            <div><strong>ğŸ“¦ ×¡×•×’:</strong> ${reg.packageType || '×œ× ×¦×•×™×Ÿ'}</div>
            <div><strong>ğŸ™ï¸ ×¢×™×¨:</strong> ${reg.city}</div>
            ${reg.phone ? `<div><strong>ğŸ“± ×˜×œ×¤×•×Ÿ:</strong> ${reg.phone}</div>` : ''}
            ${reg.notes ? `<div><strong>ğŸ“ ×”×¢×¨×•×ª:</strong> ${reg.notes}</div>` : ''}
          </div>
          ${!reg.packageReceived ? `
            <button class="btn-mark-delivered" onclick="markAsDelivered('${reg.id}', '${reg.fullName}', '${reg.phone || ''}', '${reg.city}', '${reg.registrationNumber || ''}')">
              âœ… ×¡××Ÿ ×›× ××¡×¨
            </button>
          ` : ''}
        </div>
      `;
    });

    listDiv.innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>×œ× × ××¦××• ×ª×•×¦××•×ª</p></div>';
  }

  window.filterRegistrations = function() {
    const searchTerm = document.getElementById('searchBox').value.trim().toUpperCase();
    if (!searchTerm) return displayRegistrations(allRegistrations);

    const filtered = allRegistrations.filter(reg => (reg.registrationNumber || '').toUpperCase().includes(searchTerm));
    displayRegistrations(filtered);
  };

  window.exportToExcel = function() {
    if (allRegistrations.length === 0) return alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×');

    let csvContent = '\uFEFF';
    csvContent += '××¡×¤×¨ ×”×–×× ×”,×©×,×ª.×–,×˜×œ×¤×•×Ÿ,×¢×™×¨,×¡×•×’ ×—×‘×™×œ×”,×¡×˜×˜×•×¡,×”×¢×¨×•×ª\n';

    allRegistrations.forEach(reg => {
      const status = reg.packageReceived ? '× ××¡×¨' : '×××ª×™×Ÿ';
      const row = [
        reg.registrationNumber || '',
        reg.fullName || '',
        reg.idNumber || '',
        reg.phone || '',
        reg.city || '',
        reg.packageType || '',
        status,
        (reg.notes || '').replace(/,/g, ';')
      ].join(',');
      csvContent += row + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    const branchName = userSession.branch || '×›×œ_×”×¡× ×™×¤×™×';
    const date = new Date().toISOString().split('T')[0];
    const filename = `×¨×©×•××™×_${branchName}_${date}.csv`;

    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // âœ… Mark as delivered (with optional SMS to client)
  window.markAsDelivered = async function(docId, clientName, clientPhone, city, regNumber) {
    if (!confirm('×œ×¡××Ÿ ×—×‘×™×œ×” ×–×• ×›× ××¡×¨×”?')) return;

    try {
      await updateDoc(doc(db, 'registrations', docId), {
        packageReceived: true,
        receivedDate: serverTimestamp()
      });

      if (clientPhone) {
        const to = formatILPhoneToE164(clientPhone);
        const qrLink = `https://sssnoy81-alt.github.io/Meir_panim/qr.html?code=${encodeURIComponent(regNumber)}`;

        const smsBody =
`×××™×¨ ×¤× ×™× âœ…
×”×—×‘×™×œ×” ×¡×•×× ×” ×›× ××¡×¨×”.

××¡×¤×¨ ×”×–×× ×”: ${regNumber}
×œ×¡×¨×™×§×ª QR:
${qrLink}

×ª×•×“×” ×•×‘×¨×™××•×ª!`;

        await sendSms(to, smsBody);
      }

      loadRegistrations();
    } catch (error) {
      console.error('Error:', error);
      alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ');
    }
  };
</script>
</body>
</html>
