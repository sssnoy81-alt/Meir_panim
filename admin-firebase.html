<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ×‘×§×¨×” - ×××™×¨ ×¤× ×™×</title>
    <meta name="description" content="××¢×¨×›×ª × ×™×”×•×œ ×—×œ×•×§×ª ×—×‘×™×œ×•×ª ××–×•×Ÿ - ×‘×™×ª ×ª××—×•×™ ×××™×¨ ×¤× ×™×">
    <meta name="theme-color" content="#8B1538">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="×××™×¨ ×¤× ×™×">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="users-config.js"></script>
    <script>
        const authData = sessionStorage.getItem("meirPanimAuth");
        const authTime = sessionStorage.getItem("meirPanimAuthTime");
        let userSession = null;
        if (!authData || !authTime) {
            window.location.href = "login.html?redirect=admin-firebase.html";
        } else {
            const now = new Date().getTime();
            const elapsed = now - parseInt(authTime);
            const hours24 = 24 * 60 * 60 * 1000;
            if (elapsed >= hours24) {
                sessionStorage.removeItem("meirPanimAuth");
                sessionStorage.removeItem("meirPanimAuthTime");
                window.location.href = "login.html?redirect=admin-firebase.html";
            } else {
                userSession = JSON.parse(authData);
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }

        .header {
            background: linear-gradient(135deg, #8B1538 0%, #E4032E 100%);
            color: white; padding: 25px 30px; border-radius: 15px;
            margin-bottom: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .header-top {
            display: flex; justify-content: space-between; align-items: flex-start;
            flex-wrap: wrap; gap: 12px; margin-bottom: 12px;
        }
        .header h1 { font-size: 28px; }
        .header-btns { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

        .back-btn {
            background: rgba(255,255,255,0.95); color: #8B1538;
            border: none; padding: 10px 20px; border-radius: 8px;
            cursor: pointer; font-weight: 700; font-size: 14px;
            font-family: inherit; text-decoration: none;
            display: inline-flex; align-items: center; gap: 6px;
            transition: transform 0.2s;
        }
        .back-btn:hover { transform: translateY(-1px); }

        .logout-btn {
            background: rgba(255,255,255,0.2); color: white;
            border: 2px solid white; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 600;
            font-family: inherit;
        }
        .logout-btn:hover { background: white; color: #8B1538; }

        .user-info {
            background: rgba(255,255,255,0.2); padding: 8px 16px;
            border-radius: 8px; display: inline-block; font-size: 14px;
        }

        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1); text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { font-size: 40px; margin-bottom: 10px; }
        .stat-number { font-size: 48px; font-weight: bold; color: #8B1538; margin: 10px 0; }
        .stat-label { font-size: 16px; color: #666; font-weight: 600; }

        .progress-bar-container {
            background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden; margin-top: 10px;
        }
        .progress-bar {
            height: 100%; background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s; display: flex; align-items: center;
            justify-content: center; color: white; font-weight: bold;
        }

        .panel {
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1); margin-bottom: 30px;
        }
        .panel h2 { color: #8B1538; margin-bottom: 20px; font-size: 22px; }

        .branch-row {
            display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 2fr;
            padding: 13px 15px; border-bottom: 1px solid #e0e0e0; align-items: center;
            font-size: 14px;
        }
        .branch-row:first-child { background: #f8f9fa; font-weight: 700; border-radius: 8px; }
        .branch-row:hover:not(:first-child) { background: #f8f9fa; }

        .registration-item {
            padding: 14px; border-right: 4px solid #8B1538;
            background: #f8f9fa; margin-bottom: 10px; border-radius: 8px;
            display: grid; grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px; align-items: center;
        }
        .registration-item.delivered { border-right-color: #28a745; opacity: 0.7; }
        .reg-info { font-size: 14px; }
        .reg-info strong { color: #333; }

        .delete-btn {
            background: #dc3545; color: white; border: none;
            padding: 8px 15px; border-radius: 6px; cursor: pointer;
            font-size: 14px; font-weight: 600;
        }
        .delete-btn:hover { background: #c82333; }

        .search-box {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 15px; margin-bottom: 20px;
            font-family: inherit;
        }
        .search-box:focus { outline: none; border-color: #8B1538; }

        .export-btn {
            background: #28a745; color: white; border: none;
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-weight: 600; font-family: inherit; font-size: 14px;
        }

        .loading { text-align: center; padding: 40px; color: #666; font-size: 16px; }

        .pkg-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px; margin-top: 8px;
        }
        .pkg-card {
            border: 2px solid #e5e7eb; border-radius: 12px; padding: 18px;
            text-align: center; position: relative; overflow: hidden;
        }
        .pkg-card::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; height: 4px;
        }
        .pkg-card.food::before  { background: #8B1538; }
        .pkg-card.voucher::before { background: #2563eb; }
        .pkg-card.both::before  { background: #16a34a; }
        .pkg-name { font-size: 15px; font-weight: 700; color: #333; margin-bottom: 12px; }
        .pkg-nums { display: flex; justify-content: space-around; margin-bottom: 12px; }
        .pkg-num-item { text-align: center; }
        .pkg-num { font-size: 26px; font-weight: 800; color: #8B1538; }
        .pkg-num.green { color: #16a34a; }
        .pkg-num.gray  { color: #6b7280; }
        .pkg-num-lbl { font-size: 11px; color: #888; margin-top: 2px; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header h1 { font-size: 22px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .branch-row { grid-template-columns: 1fr 1fr; gap: 5px; }
            .registration-item { grid-template-columns: 1fr; }
            .stat-number { font-size: 36px; }
        }
    </style>
</head>
<body>
<div class="container">

    <div class="header">
        <div class="header-top">
            <h1>ğŸ“Š ×œ×•×— ×‘×§×¨×”</h1>
            <div class="header-btns">
                <a href="volunteer-firebase.html" class="back-btn">ğŸ¤ ×× ×”×œ ×¡× ×™×£</a>
                <button class="logout-btn" onclick="logout()">ğŸšª ×”×ª× ×ª×§</button>
            </div>
        </div>
        <div class="user-info">
            <strong id="userName"></strong>
            <span id="userBranch" style="margin-right:10px;font-size:13px;opacity:0.9;"></span>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ğŸ‘¥</div>
            <div class="stat-number" id="totalFamilies">0</div>
            <div class="stat-label">×¡×”"×› ××©×¤×—×•×ª ×¨×©×•××•×ª</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-number" id="distributedPackages">0</div>
            <div class="stat-label">×—×‘×™×œ×•×ª ×©× ××¡×¨×•</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">â³</div>
            <div class="stat-number" id="pendingPackages">0</div>
            <div class="stat-label">×××ª×™×Ÿ ×œ××¡×™×¨×”</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ“ˆ</div>
            <div class="stat-number" id="completionRate">0%</div>
            <div class="stat-label">××—×•×– ×”×©×œ××”</div>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar" style="width:0%"></div>
            </div>
        </div>
    </div>

    <div class="panel" id="branchStatsSection">
        <h2>ğŸ“ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×œ×¤×™ ×¡× ×™×£</h2>
        <div id="branchStats"><div class="loading">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div></div>
    </div>

    <div class="panel">
        <h2>ğŸ“¦ ×¤×™×œ×•×— ×œ×¤×™ ×¡×•×’ ×—×‘×™×œ×”</h2>
        <div id="packageStats"><div class="loading">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div></div>
    </div>

    <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
            <h2 style="margin:0;">ğŸ“‹ ×¨×™×©×•××™× ××—×¨×•× ×™×</h2>
            <button class="export-btn" onclick="exportAdminToExcel()">ğŸ“Š ×™×™×¦× ×œ××§×¡×œ</button>
        </div>
        <input type="text" id="adminSearchBox" class="search-box"
               placeholder="ğŸ” ×—×™×¤×•×© ×œ×¤×™ ×©×, ××¡×¤×¨ ×”×–×× ×” ××• ×ª.×–"
               oninput="filterAdminRegistrations()">
        <div id="recentRegistrations"><div class="loading">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div></div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, deleteDoc, query, where }
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAmaAzUatTV97LwL4VoVEUrJoVpnF612ig",
        authDomain: "meir-panim-f27c4.firebaseapp.com",
        projectId: "meir-panim-f27c4",
        storageBucket: "meir-panim-f27c4.firebasestorage.app",
        messagingSenderId: "1031695732717",
        appId: "1:1031695732717:web:eb13bc9f6ff0c80156cdd3"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    let allAdminRegistrations = [];

    document.getElementById("userName").textContent = userSession.hebrewName;
    document.getElementById("userBranch").textContent = userSession.branch
        ? "×¡× ×™×£: " + userSession.branch
        : (userSession.level === 3 ? "Super Admin" : "Admin ×¨××©×™");

    window.logout = function() {
        sessionStorage.removeItem("meirPanimAuth");
        sessionStorage.removeItem("meirPanimAuthTime");
        window.location.href = "login.html";
    };

    async function updateDashboard() {
        try {
            let snap;
            if (userSession.permissions.viewAll) {
                snap = await getDocs(collection(db, "registrations"));
            } else {
                snap = await getDocs(query(collection(db,"registrations"), where("city","==",userSession.branch)));
            }

            const regs = [];
            snap.forEach(d => regs.push({ id: d.id, ...d.data() }));
            allAdminRegistrations = regs;

            const total = regs.length;
            const delivered = regs.filter(r => r.packageReceived).length;
            const pending = total - delivered;
            const rate = total > 0 ? Math.round((delivered / total) * 100) : 0;

            document.getElementById("totalFamilies").textContent = total;
            document.getElementById("distributedPackages").textContent = delivered;
            document.getElementById("pendingPackages").textContent = pending;
            document.getElementById("completionRate").textContent = rate + "%";
            const pb = document.getElementById("progressBar");
            pb.style.width = rate + "%";
            pb.textContent = rate + "%";

            updateBranchStats(regs);
            updatePackageStats(regs);
            updateRecentRegistrations(regs);
        } catch(e) {
            console.error("Dashboard error:", e);
        }
    }

    function updatePackageStats(regs) {
        const packages = [
            { key: "×—×‘×™×œ×ª ××–×•×Ÿ",   label: "×—×‘×™×œ×ª ××–×•×Ÿ",   cls: "food",    icon: "ğŸ“¦" },
            { key: "×ª×œ×•×©/×©×•×‘×¨",    label: "×ª×œ×•×© / ×©×•×‘×¨",  cls: "voucher", icon: "ğŸ«" },
            { key: "×—×‘×™×œ×” + ×©×•×‘×¨", label: "×—×‘×™×œ×” + ×©×•×‘×¨", cls: "both",    icon: "ğŸ" }
        ];

        const cards = packages.map(pkg => {
            const pkgRegs = regs.filter(r => r.packageType === pkg.key);
            const total     = pkgRegs.length;
            const delivered = pkgRegs.filter(r => r.packageReceived).length;
            const pending   = total - delivered;
            const rate      = total > 0 ? Math.round((delivered / total) * 100) : 0;

            return `
            <div class="pkg-card ${pkg.cls}">
                <div class="pkg-name">${pkg.icon} ${pkg.label}</div>
                <div class="pkg-nums">
                    <div class="pkg-num-item">
                        <div class="pkg-num">${total}</div>
                        <div class="pkg-num-lbl">×¡×”"×›</div>
                    </div>
                    <div class="pkg-num-item">
                        <div class="pkg-num green">${delivered}</div>
                        <div class="pkg-num-lbl">× ××¡×¨×•</div>
                    </div>
                    <div class="pkg-num-item">
                        <div class="pkg-num gray">${pending}</div>
                        <div class="pkg-num-lbl">×××ª×™× ×™×</div>
                    </div>
                </div>
                <div class="progress-bar-container" style="height:18px;">
                    <div class="progress-bar" style="width:${rate}%;font-size:11px;">${rate > 10 ? rate+"%" : ""}</div>
                </div>
                <div style="font-size:12px;color:#888;margin-top:6px;">${rate}% ×”×•×©×œ×</div>
            </div>`;
        });

        document.getElementById("packageStats").innerHTML =
            `<div class="pkg-grid">${cards.join("")}</div>`;
    }

    function updateBranchStats(regs) {
        if (!userSession.permissions.viewAll) {
            document.getElementById("branchStatsSection").style.display = "none";
            return;
        }
        const cities = ["×™×¨×•×©×œ×™×","×¦×¤×ª","×“×™××•× ×”","××•×¨ ×¢×§×™×‘×","×˜×‘×¨×™×”"];
        const data = cities.map(city => {
            const cr = regs.filter(r => r.city === city);
            const total = cr.length;
            const delivered = cr.filter(r => r.packageReceived).length;
            const rate = total > 0 ? Math.round((delivered/total)*100) : 0;
            return { city, total, delivered, pending: total-delivered, rate };
        });

        document.getElementById("branchStats").innerHTML =
            `<div class="branch-row">
                <div><strong>×¡× ×™×£</strong></div><div><strong>×¡×”"×›</strong></div>
                <div><strong>× ××¡×¨</strong></div><div><strong>×××ª×™×Ÿ</strong></div>
                <div><strong>××—×•×– ×”×©×œ××”</strong></div>
             </div>` +
            data.map(b => `
            <div class="branch-row">
                <div>${b.city}</div><div>${b.total}</div>
                <div>${b.delivered}</div><div>${b.pending}</div>
                <div>
                    <div class="progress-bar-container" style="height:20px;">
                        <div class="progress-bar" style="width:${b.rate}%;font-size:12px;">${b.rate}%</div>
                    </div>
                </div>
            </div>`).join("");
    }

    function updateRecentRegistrations(regs) {
        const div = document.getElementById("recentRegistrations");
        const sorted = [...regs].sort((a,b) => {
            const da = a.registrationDate?.toDate?.() || new Date(0);
            const db2 = b.registrationDate?.toDate?.() || new Date(0);
            return db2 - da;
        });

        if (!sorted.length) { div.innerHTML = "<div class=\"loading\">××™×Ÿ ×¨×™×©×•××™× ×¢×“×™×™×Ÿ</div>"; return; }

        div.innerHTML = sorted.map(reg => `
            <div class="registration-item ${reg.packageReceived ? "delivered" : ""}"
                 data-registration-number="${reg.registrationNumber || ""}">
                <div class="reg-info">
                    <strong>${reg.registrationNumber || ""}</strong><br>${reg.fullName || ""}
                </div>
                <div class="reg-info">
                    <strong>×¢×™×¨:</strong> ${reg.city || ""}<br>
                    <strong>×¡×•×’:</strong> ${reg.packageType || ""}
                </div>
                <div class="reg-info">
                    <strong>×¡×˜×˜×•×¡:</strong><br>
                    ${reg.packageReceived ? "âœ… × ××¡×¨" : "â³ ×××ª×™×Ÿ"}
                </div>
                <div>
                    ${userSession.permissions.delete
                        ? `<button class="delete-btn" onclick="deleteRegistration(\'${reg.id}\', \'${(reg.fullName||"").replace(/\'/g,"")}\'")">ğŸ—‘ï¸ ××—×§</button>`
                        : ""}
                </div>
            </div>`).join("");
    }

    window.deleteRegistration = async function(docId, name) {
        if (!userSession.permissions.delete) { alert("××™×Ÿ ×”×¨×©××” ×œ××—×•×§"); return; }
        if (!confirm(`×œ××—×•×§ ××ª ×”×¨×™×©×•× ×©×œ ${name}?\n\n×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`)) return;
        try {
            await deleteDoc(doc(db, "registrations", docId));
            alert("×”×¨×™×©×•× × ××—×§ ×‘×”×¦×œ×—×”");
            updateDashboard();
        } catch(e) { alert("×©×’×™××”: " + e.message); }
    };

    window.filterAdminRegistrations = function() {
        const term = document.getElementById("adminSearchBox").value.trim().toLowerCase();
        if (!term) { updateRecentRegistrations(allAdminRegistrations); return; }
        const filtered = allAdminRegistrations.filter(r =>
            (r.registrationNumber||"").toLowerCase().includes(term) ||
            (r.fullName||"").toLowerCase().includes(term) ||
            (r.idNumber||"").includes(term)
        );
        updateRecentRegistrations(filtered);
    };

    window.exportAdminToExcel = function() {
        if (!allAdminRegistrations.length) { alert("××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×"); return; }
        let csv = "\uFEFF";
        csv += "××¡×¤×¨ ×”×–×× ×”,×©×,×ª.×–,×˜×œ×¤×•×Ÿ,×¢×™×¨,×¡×•×’ ×—×‘×™×œ×”,×¡×˜×˜×•×¡,×”×¢×¨×•×ª\n";
        allAdminRegistrations.forEach(r => {
            csv += [
                r.registrationNumber||"", r.fullName||"", r.idNumber||"",
                r.phone||"", r.city||"", r.packageType||"",
                r.packageReceived ? "× ××¡×¨" : "×××ª×™×Ÿ",
                (r.notes||"").replace(/,/g,";")
            ].join(",") + "\n";
        });
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `×“×•×—_${userSession.branch||"×›×œ_×”×¡× ×™×¤×™×"}_${new Date().toISOString().split("T")[0]}.csv`;
        a.click();
    };

    updateDashboard();
    setInterval(updateDashboard, 30000);
</script>
</body>
</html>
