<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×¨×™×©×•× ×œ××©×¤×—×•×ª - ×‘×™×ª ×ª××—×•×™ ×××™×¨ ×¤× ×™×</title>

<style>
body{
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg,#8B1538 0%,#E4032E 100%);
    min-height:100vh;
    padding:20px;
}
.container{
    max-width:600px;
    margin:auto;
    background:white;
    border-radius:20px;
    padding:30px;
}
.submit-btn{
    width:100%;
    padding:15px;
    background:#8B1538;
    color:white;
    border:none;
    border-radius:10px;
    font-size:18px;
    cursor:pointer;
}
.success-message{
    display:none;
    background:#d4edda;
    padding:20px;
    border-radius:10px;
    margin-top:20px;
    text-align:center;
}
.success-message.show{
    display:block;
}
</style>
</head>

<body>
<div class="container">

<h2>×¨×™×©×•× ××©×¤×—×•×ª â€” ×××™×¨ ×¤× ×™×</h2>

<form id="registrationForm">

<input id="fullName" required placeholder="×©× ××œ×"><br><br>
<input id="idNumber" required placeholder="×ª×¢×•×“×ª ×–×”×•×ª"><br><br>
<input id="phone" required placeholder="×˜×œ×¤×•×Ÿ"><br><br>

<select id="city" required>
<option value="">×‘×—×¨ ×¢×™×¨</option>
<option>×™×¨×•×©×œ×™×</option>
<option>×¦×¤×ª</option>
<option>×“×™××•× ×”</option>
<option>××•×¨ ×¢×§×™×‘×</option>
<option>×˜×‘×¨×™×”</option>
</select><br><br>

<select id="packageType" required>
<option value="">×‘×—×¨ ×¡×•×’ ×—×‘×™×œ×”</option>
<option>×—×‘×™×œ×ª ××–×•×Ÿ</option>
<option>×ª×œ×•×©/×©×•×‘×¨</option>
<option>×—×‘×™×œ×” + ×©×•×‘×¨</option>
</select><br><br>

<button type="submit" class="submit-btn" id="submitBtn">
×©×œ×— ×¨×™×©×•×
</button>

</form>

<div id="successMessage" class="success-message">
<h3>âœ… × ×¨×©××ª ×‘×”×¦×œ×—×”!</h3>
<p>××¡×¤×¨ ×”×”×–×× ×” ×©×œ×š:</p>
<h2 id="registrationNumber"></h2>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ğŸ”¥ Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAmnAzUatfV97LwL4VoVEUrJoVnnF6I2J4",
  authDomain: "meir-panim-f27c4.firebaseapp.com",
  projectId: "meir-panim-f27c4",
  storageBucket: "meir-panim-f27c4.appspot.com",
  messagingSenderId: "252083260218",
  appId: "1:252083260218:web:ea5e1ef072ae048191dd1e03"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const form = document.getElementById("registrationForm");
const successBox = document.getElementById("successMessage");
const regNumEl = document.getElementById("registrationNumber");
const submitBtn = document.getElementById("submitBtn");

/* ========================= */
/* ğŸš€ SUBMIT */
/* ========================= */

form.addEventListener("submit", async (e) => {
    e.preventDefault();

    submitBtn.disabled = true;
    submitBtn.textContent = "×©×•××¨...";

    const registrationNumber =
        "MP" + Date.now().toString().slice(-8);

    const formData = {
        fullName: fullName.value,
        idNumber: idNumber.value,
        phone: phone.value,
        city: city.value,
        packageType: packageType.value,
        registrationNumber,
        registrationDate: serverTimestamp()
    };

    try {
        /* ğŸ’¾ ×©××™×¨×” */
        await addDoc(collection(db, "registrations"), formData);

        /* ğŸ“± ×¤×•×¨××˜ ×˜×œ×¤×•×Ÿ */
        let formattedPhone = formData.phone.replace(/\D/g, "");

        if (formattedPhone.startsWith("0")) {
            formattedPhone = "+972" + formattedPhone.substring(1);
        } else if (!formattedPhone.startsWith("+")) {
            formattedPhone = "+972" + formattedPhone;
        }

        /* ğŸ”¥ QR LINK */
        const qrLink =
            "https://sssnoy81-alt.github.io/Meir_panim/qr.html?code=" +
            registrationNumber;

        /* ğŸ“© ×”×•×“×¢×ª SMS */
        const smsBody =
`×××™×¨ ×¤× ×™×

××¡×¤×¨ ×”×”×–×× ×” ×©×œ×š:
${registrationNumber}

×œ×¡×¨×™×§×ª QR:
${qrLink}

×©××•×¨ ×”×•×“×¢×” ×–×•.`;


        /* ğŸš€ ×©×œ×™×—×” ×œ×˜×•×•×™×œ×™×• ×“×¨×š ×”-Worker ×©×œ×š */
        await fetch(
            "https://meir-panim-sms.sssnoy81.workers.dev/",
            {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    to: formattedPhone,
                    body: smsBody
                })
            }
        );

        /* âœ… ×”×¦×œ×—×” */
        regNumEl.textContent = registrationNumber;
        form.style.display = "none";
        successBox.classList.add("show");

    } catch (err) {
        console.error(err);
        alert("×©×’×™××” ×‘×©×œ×™×—×”");
        submitBtn.disabled = false;
        submitBtn.textContent = "×©×œ×— ×¨×™×©×•×";
    }
});
</script>
</body>
</html>