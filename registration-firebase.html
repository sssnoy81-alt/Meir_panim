<!-- registration-firebase.html
     Meir Panim - Registration (Production-ready)
     Replace your GitHub file with this one AS-IS.

     ✅ One-way flow (no reply needed)
     ✅ Sends registration to Cloudflare Worker
     ✅ Worker sends SMS with order number + QR link
     ✅ Hardened: auto-tries multiple endpoints to avoid "Not found"
     ✅ Hebrew UI + clean mobile layout
-->
<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>רישום משפחה חדשה</title>

  <meta name="theme-color" content="#7b1230" />
  <style>
    :root{
      --bg:#7b1230;
      --card:#ffffff;
      --muted:#6b7280;
      --ok:#16a34a;
      --bad:#dc2626;
      --line:#e5e7eb;
      --btn:#7b1230;
      --btn2:#111827;
      --soft:#f8fafc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Hebrew", sans-serif;
      background: var(--bg);
      color:#111;
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:24px 12px;
    }
    .wrap{width:min(720px, 100%)}
    .card{
      background:var(--card);
      border-radius:18px;
      padding:18px;
      box-shadow: 0 12px 40px rgba(0,0,0,.22);
    }
    h1{
      margin:6px 0 14px;
      font-size:26px;
      text-align:center;
      color:#111;
    }
    .sub{
      margin:0 0 14px;
      text-align:center;
      color:var(--muted);
      font-size:14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:640px){
      .grid{grid-template-columns:1fr}
    }
    label{
      display:block;
      font-size:13px;
      color:#111827;
      margin:2px 0 6px;
      font-weight:600;
    }
    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 12px;
      font-size:16px;
      background:#fff;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color:#c084fc;
      box-shadow: 0 0 0 4px rgba(192,132,252,.18);
    }
    textarea{min-height:86px; resize:vertical}
    .row{margin-top:10px}
    .actions{
      display:flex;
      gap:10px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    button{
      border:none;
      border-radius:12px;
      padding:12px 14px;
      font-size:16px;
      cursor:pointer;
      font-weight:700;
    }
    .btn{
      background:var(--btn);
      color:#fff;
      flex:1;
      min-width:180px;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn2{
      background:var(--btn2);
      color:#fff;
    }
    .note{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    .banner{
      border-radius:14px;
      padding:12px 12px;
      margin:10px 0 14px;
      display:none;
      align-items:center;
      gap:10px;
      border:1px solid var(--line);
      background:var(--soft);
    }
    .banner.show{display:flex}
    .banner.ok{
      border-color: rgba(22,163,74,.35);
      background: rgba(22,163,74,.10);
    }
    .banner.bad{
      border-color: rgba(220,38,38,.35);
      background: rgba(220,38,38,.10);
    }
    .badge{
      min-width:30px;
      height:30px;
      border-radius:999px;
      display:grid;
      place-items:center;
      font-weight:900;
      color:#fff;
      flex:0 0 auto;
    }
    .badge.ok{background:var(--ok)}
    .badge.bad{background:var(--bad)}
    .banner .txt{
      flex:1;
      font-size:14px;
      line-height:1.35;
      color:#111827;
      white-space:pre-wrap;
    }

    .result{
      display:none;
      margin-top:12px;
      border:1px dashed #cbd5e1;
      background:#f8fafc;
      border-radius:14px;
      padding:12px;
    }
    .result.show{display:block}
    .result h2{
      margin:0 0 8px;
      font-size:18px;
    }
    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:8px 10px;
      align-items:center;
      font-size:14px;
    }
    @media (max-width:640px){
      .kv{grid-template-columns: 110px 1fr}
    }
    .k{color:#374151; font-weight:700}
    .v{
      color:#111827;
      word-break:break-word;
      background:#fff;
      border:1px solid #e5e7eb;
      padding:8px 10px;
      border-radius:10px;
    }
    .mini-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .link{
      display:inline-block;
      text-decoration:none;
      color:#111827;
      background:#fff;
      border:1px solid #e5e7eb;
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
    }
    .qrBox{
      margin-top:10px;
      display:flex;
      justify-content:center;
    }
    #qrCanvas{
      width:220px;
      height:220px;
      border-radius:14px;
      background:#fff;
      border:1px solid #e5e7eb;
      padding:10px;
      display:none;
    }
  </style>

  <!-- QR code generator (reliable CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" defer></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>רישום משפחה חדשה</h1>
      <p class="sub">מילוי פרטים ושליחת אישור SMS עם מספר הזמנה וקישור QR למסירה</p>

      <div id="banner" class="banner">
        <div id="badge" class="badge">!</div>
        <div id="bannerText" class="txt"></div>
      </div>

      <form id="regForm" autocomplete="off" novalidate>
        <div class="grid">
          <div>
            <label for="fullName">שם מלא *</label>
            <input id="fullName" name="fullName" type="text" placeholder="לדוגמה: יפה נוימן" required />
          </div>

          <div>
            <label for="idNumber">מספר תעודת זהות *</label>
            <input id="idNumber" name="idNumber" type="text" inputmode="numeric" placeholder="לדוגמה: 012345678" required />
          </div>

          <div>
            <label for="phone">טלפון נייד *</label>
            <input id="phone" name="phone" type="tel" inputmode="tel" placeholder="05XXXXXXXX או +9725XXXXXXXX" required />
          </div>

          <div>
            <label for="branch">סניף *</label>
            <select id="branch" name="branch" required>
              <option value="">בחר סניף</option>
              <option value="Jerusalem">ירושלים</option>
              <option value="Or_Akiva">אור עקיבא</option>
              <option value="Hadera">חדרה</option>
              <option value="Tiberias">טבריה</option>
              <option value="Tzfat">צפת</option>
            </select>
          </div>

          <div>
            <label for="familySize">גודל משפחה</label>
            <input id="familySize" name="familySize" type="number" min="1" max="30" placeholder="לדוגמה: 6" />
          </div>

          <div>
            <label for="packageType">סוג חבילה</label>
            <select id="packageType" name="packageType">
              <option value="Standard">חבילה רגילה</option>
              <option value="Standard_Plus">חבילה + שוברים</option>
              <option value="Passover">פסח</option>
              <option value="Holiday">חג</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label for="notes">הערות</label>
          <textarea id="notes" name="notes" placeholder="צרכים מיוחדים, אלרגיות, הערות למנהל הסניף וכו'"></textarea>
        </div>

        <div class="actions">
          <button id="submitBtn" class="btn" type="submit">שלח רישום</button>
          <button id="resetBtn" class="btn2" type="button">נקה טופס</button>
        </div>

        <div class="note">
          • שליחה חד-כיוונית: אין צורך שהלקוח ישיב. <br/>
          • אם יש בעיית “Not found” או שינוי בנתיב Worker — הקובץ הזה מנסה כמה נתיבים אוטומטית.
        </div>
      </form>

      <div id="result" class="result">
        <h2>✅ נרשם בהצלחה</h2>
        <div class="kv">
          <div class="k">מספר הזמנה</div><div class="v" id="orderId">-</div>
          <div class="k">טלפון</div><div class="v" id="phoneOut">-</div>
          <div class="k">סניף</div><div class="v" id="branchOut">-</div>
          <div class="k">קישור QR</div><div class="v" id="qrLinkOut">-</div>
        </div>

        <div class="mini-actions">
          <a id="openQr" class="link" href="#" target="_blank" rel="noopener">פתח QR</a>
          <button id="copyOrder" class="link" type="button">העתק מספר הזמנה</button>
          <button id="copyQr" class="link" type="button">העתק קישור QR</button>
        </div>

        <div class="qrBox">
          <div id="qrCanvas"></div>
        </div>
      </div>

    </div>
  </div>

<script>
/* ===========================
   CONFIG (update only if needed)
   =========================== */
const WORKER_BASE = "https://meir-panim-sms.sssnoy81.workers.dev";

/**
 * We will try these endpoints in order until one works.
 * This prevents "Not found" when the Worker path changed.
 */
const ENDPOINTS = [
  "/register",   // recommended
  "/send",       // legacy
  "/issue",      // legacy
  "/api/register",
  "/api/send",
  "/v1/register",
];

/* ===========================
   Helpers
   =========================== */
const $ = (id) => document.getElementById(id);

function showBanner(type, text){
  const banner = $("banner");
  const badge = $("badge");
  const bannerText = $("bannerText");

  banner.classList.remove("ok","bad","show");
  badge.classList.remove("ok","bad");

  if(type === "ok"){
    banner.classList.add("ok","show");
    badge.classList.add("ok");
    badge.textContent = "✓";
  } else {
    banner.classList.add("bad","show");
    badge.classList.add("bad");
    badge.textContent = "!";
  }
  bannerText.textContent = text;
}

function hideBanner(){
  $("banner").classList.remove("show","ok","bad");
}

function normalizeIsraeliPhone(input){
  // Accept: 05XXXXXXXX, 5XXXXXXXX, +9725XXXXXXXX, 9725XXXXXXXX
  let p = (input || "").trim();
  p = p.replace(/[^\d+]/g, ""); // keep digits and +
  if(!p) return "";

  if(p.startsWith("+")) {
    // already E.164
    return p;
  }
  if(p.startsWith("972")) {
    return "+" + p;
  }
  // local formats:
  if(p.startsWith("0")) {
    // 05xxxxxxx -> +9725xxxxxxx
    p = p.slice(1);
    return "+972" + p;
  }
  // if they typed 5xxxxxxxx
  if(p.startsWith("5")) {
    return "+972" + p;
  }
  // fallback: if they typed something else, return as-is (will fail validation later)
  return p.startsWith("+") ? p : ("+" + p);
}

function cleanIdNumber(id){
  return (id || "").replace(/[^\d]/g, "").trim();
}

function safeStr(v){
  return String(v ?? "").trim();
}

async function postJSON(url, body, timeoutMs = 15000){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);

  try{
    const res = await fetch(url, {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body),
      signal: controller.signal,
      // credentials not needed
    });

    let data = null;
    const ct = res.headers.get("content-type") || "";
    if(ct.includes("application/json")){
      data = await res.json().catch(() => null);
    } else {
      const text = await res.text().catch(() => "");
      data = { ok:false, error: text || "Non-JSON response" };
    }

    return { res, data };
  } finally {
    clearTimeout(t);
  }
}

function mapBranchLabel(branchValue){
  const map = {
    "Jerusalem":"ירושלים",
    "Or_Akiva":"אור עקיבא",
    "Hadera":"חדרה",
    "Tiberias":"טבריה",
    "Tzfat":"צפת"
  };
  return map[branchValue] || branchValue || "-";
}

async function tryWorker(payload){
  // Try endpoints until one returns ok:true OR returns a meaningful JSON (even if ok:false but not 404).
  const errors = [];

  for(const path of ENDPOINTS){
    const url = WORKER_BASE.replace(/\/+$/,"") + path;

    try{
      const {res, data} = await postJSON(url, payload);

      // If endpoint doesn't exist, Worker usually returns 404 with text/JSON.
      // We'll treat 404 as "try next".
      if(res.status === 404 || (data && typeof data.error === "string" && /not\s*found/i.test(data.error))){
        errors.push(`404 on ${path}`);
        continue;
      }

      // Any non-404 response: return it (either ok or meaningful error)
      return { url, status: res.status, data };
    } catch (e){
      errors.push(`${path}: ${e?.name === "AbortError" ? "timeout" : (e?.message || "network error")}`);
      continue;
    }
  }

  return { url: null, status: 0, data: { ok:false, error: "No valid endpoint found", details: errors } };
}

/* ===========================
   UI handlers
   =========================== */
function setLoading(isLoading){
  const btn = $("submitBtn");
  btn.disabled = isLoading;
  btn.textContent = isLoading ? "שולח..." : "שלח רישום";
}

function showResult({orderId, phone, branchLabel, qrLink}){
  $("orderId").textContent = orderId || "-";
  $("phoneOut").textContent = phone || "-";
  $("branchOut").textContent = branchLabel || "-";
  $("qrLinkOut").textContent = qrLink || "-";

  const openQr = $("openQr");
  if(qrLink){
    openQr.href = qrLink;
    openQr.style.pointerEvents = "auto";
    openQr.style.opacity = "1";
  } else {
    openQr.href = "#";
    openQr.style.pointerEvents = "none";
    openQr.style.opacity = "0.6";
  }

  $("result").classList.add("show");

  // Render QR
  const box = $("qrCanvas");
  box.style.display = "none";
  box.innerHTML = "";

  if(qrLink && window.QRCode){
    window.QRCode.toCanvas(document.createElement("canvas"), qrLink, { width: 200, margin: 1 }, (err, canvas) => {
      if(!err && canvas){
        box.appendChild(canvas);
        box.style.display = "block";
      }
    });
  }
}

function hideResult(){
  $("result").classList.remove("show");
}

/* ===========================
   Main submit
   =========================== */
$("regForm").addEventListener("submit", async (ev) => {
  ev.preventDefault();
  hideBanner();
  hideResult();

  // Collect
  const fullName = safeStr($("fullName").value);
  const idNumber = cleanIdNumber($("idNumber").value);
  const phoneRaw = safeStr($("phone").value);
  const phone = normalizeIsraeliPhone(phoneRaw);
  const branch = safeStr($("branch").value);
  const familySize = safeStr($("familySize").value);
  const packageType = safeStr($("packageType").value);
  const notes = safeStr($("notes").value);

  // Validate (client-side)
  if(!fullName || fullName.length < 2){
    showBanner("bad", "נא למלא שם מלא תקין.");
    return;
  }
  if(!idNumber || idNumber.length < 7){
    showBanner("bad", "נא למלא מספר תעודת זהות תקין.");
    return;
  }
  if(!phone || !phone.startsWith("+") || phone.length < 10){
    showBanner("bad", "נא למלא מספר טלפון תקין (05XXXXXXXX או +9725XXXXXXXX).");
    return;
  }
  if(!branch){
    showBanner("bad", "נא לבחור סניף.");
    return;
  }

  // Payload for Worker (worker should accept these fields; extra fields won't hurt)
  const payload = {
    type: "registration",
    fullName,
    idNumber,
    phone,
    branch,
    familySize: familySize ? Number(familySize) : null,
    packageType,
    notes,
    channel: "web",
    // Helps debug routing on Worker
    clientTs: new Date().toISOString(),
    userAgent: navigator.userAgent
  };

  setLoading(true);

  try{
    const resp = await tryWorker(payload);
    const data = resp.data || {};

    if(!data.ok){
      // Show the most useful error message
      const err = data.error || data.message || "שגיאה בשליחה. נסה שוב.";
      const details = Array.isArray(data.details) ? ("\n" + data.details.join("\n")) : "";
      showBanner("bad", `${err}${details}`);
      return;
    }

    // Normalize response fields (support different worker versions)
    const orderId = data.orderId || data.order || data.code || data.confirmation || data.registrationId || "";
    const qrLink = data.qrLink || data.link || data.qr || data.verifyUrl || "";
    const branchLabel = mapBranchLabel(branch);

    showBanner("ok", `נרשמת בהצלחה! ✅\nמספר הזמנה: ${orderId || "נוצר"}\nSMS נשלח ללקוח.`);
    showResult({ orderId, phone, branchLabel, qrLink });

  } catch (e){
    showBanner("bad", `שגיאה בלתי צפויה: ${e?.message || e}`);
  } finally {
    setLoading(false);
  }
});

$("resetBtn").addEventListener("click", () => {
  $("regForm").reset();
  hideBanner();
  hideResult();
});

$("copyOrder").addEventListener("click", async () => {
  const v = $("orderId").textContent.trim();
  if(!v || v === "-") return;
  try{
    await navigator.clipboard.writeText(v);
    showBanner("ok", "הועתק מספר ההזמנה ללוח.");
  } catch {
    showBanner("bad", "לא הצלחתי להעתיק. העתק ידנית.");
  }
});

$("copyQr").addEventListener("click", async () => {
  const v = $("qrLinkOut").textContent.trim();
  if(!v || v === "-") return;
  try{
    await navigator.clipboard.writeText(v);
    showBanner("ok", "הועתק קישור ה-QR ללוח.");
  } catch {
    showBanner("bad", "לא הצלחתי להעתיק. העתק ידנית.");
  }
});
</script>
</body>
</html>
